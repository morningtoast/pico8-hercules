pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
-- hercules spinner
-- June 2024



function get_maptxy(id)
    local ty,tx=0,id*16
    if(id>7)ty,tx=16,(id-8)*16
    return tx,ty
end

function map_fget(mid,tx,ty)
    local ox,oy=get_maptxy(mid)
    return fget(mget(tx+ox,ty+oy))
end

-- pixel hitbox collide
function collide(ax,ay,ahb, bx,by,bhb, rdir)
	rdir=rdir or false
	local l = max(ax+ahb.x,        bx+bhb.x)
	local r = min(ax+ahb.x+ahb.w,  bx+bhb.x+bhb.w)
	local t = max(ay+ahb.y,        by+bhb.y)
	local b = min(ay+ahb.y+ahb.h,  by+bhb.y+bhb.h)

	-- they overlapped if the area of intersection is greater than 0
	if l < r and t < b then
		if rdir then
			local reldir = atan2(ax-bx, ay-by)

			if (reldir>=0 and reldir<.125) or (reldir<1 and reldir>=.875) then return 1 end
			if reldir>=.125 and reldir<.375 then return .25 end
			if reldir>=.625 and reldir<.625 then return .5 end
			if reldir>=.375 and reldir<.875 then return .75 end
		else
			return true
		end
	end
					
	return false
end

-- map tile collide
-- x=pixel x,y=pixel y,hb=hitbox,flag=sprite flag to check,maposx=map offset x,maposy=map offset y
-- collide(me.x,me.y, 1, 16) -- this will look at tile starting at map column 16
function collide_tile(x,y,hb,flag,maposx,maposy)
    local maposx=maposx or 0
    local maposy=maposy or 0
    local flag=flag or 1
    local collide=false

    if fget(mget(maposx+(x+hb.x)/8,         maposy+(y+hb.y)/8))==flag or --topleft
        fget(mget(maposx+(x+hb.x+hb.w)/8,   maposy+(y+hb.y)/8))==flag or --top right
        fget(mget(maposx+(x+hb.x)/8,        maposy+(y+hb.y+hb.h)/8))==flag or -- bottom left
        fget(mget(maposx+(x+hb.x+hb.w)/8,   maposy+(y+hb.y+hb.h)/8))==flag --bottom right
    then
        collide=true
    end

    return collide
end



function _init()
printh("-----reboot-------")
	map_y,map_x=-128,0

	p_x,p_y=64,100
	p_hb={x=0,y=0,w=8,h=8}
	pmap=0

	camy=128

	stream={}
	bricks={}

	-- add maps to array that get scrolled
	add(stream,{
		x=0,y=-128,bg=1,
		mapx=0,mapy=0,render=false,
	})

	--[[add(stream,{
		x=0,y=-256,bg=2,
		mapx=16,mapy=0,render=false
	})]]
end


function _update60()
    btnl,btnr,btnu,btnd,btnz,btnx=btn(0),btn(1),btn(2),btn(3),btn(4),btn(5)
	btnlp,btnrp,btnzp,btnxp,btnup,btndp=btnp(0),btnp(1),btnp(4),btnp(5),btnp(2),btnp(3)

	for o in all(stream) do
		--o.y+=.25
--printh(o.y)
		if not o.render then
		printh("read map")
			o.render=true

			-- turn tiles into objects
			for c=0,15 do
				for r=0,15 do
					usesprite=mget(o.mapx+c,o.mapy+r)
					--printh(mget(c,r))
					if usesprite>0 then
						--printh(flr(c*8)..","..-128+flr(r*8))
						brickspr=usesprite
						if usesprite==16 then brickspr=17 end
						add(bricks,{
							spr=brickspr,
							x=flr(c*8),y=-128+flr(r*8),
							hb={x=0,y=0,w=8,h=8}
						})
					end


				end
			end

			
		end

		if o.y>128 then printh("kill map") del(stream,o) end
	end

	dx,dy=0,0

	if btnl then dx=-1 end
	if btnr then dx=1 end
	if btnu then dy=-1 end
	if btnd then dy=1 end
	

	pcanmove=true
	for o in all(bricks) do
		_hit = collide(p_x+dx,p_y+dy,p_hb, o.x,o.y,o.hb, true)
		if _hit then
			pcanmove=false
			if _hit==.75 then 
				dy=.25
			end
			
		end

		o.y+=.25
		if o.y>128 then del(bricks,o) end

	end

	if pcanmove then
		p_x+=dx
		p_y+=dy
	end

	--if p_y>=camy+120 then p_y=camy+119 end

	

	

	--camy-=.25
	

end


function _draw()
	cls()
	--camera(0,camy)
	for o in all(bricks) do
		spr(o.spr,o.x,o.y)
	end

	--map(0,0,0,0,16,16)

	--printh(mget(2,0))

	

	

	--camera()
	spr(1,p_x,p_y)
	print(#bricks,10,10,7)
	

	
	
end

__gfx__
0000000000aaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000cffc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700888ff8880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000808888080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000808888080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700008888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000008008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000008008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
24444441b333333a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
14444442a333333b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1000000000000000000000000000001010000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000010000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000010000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000001010101000000000000010100000001010000010100000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000101000001010101000001010000010100000001010000010100000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000101000000000000000001010000010100000001010000010100000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000101000000000000000001010000010100000001010000010100000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000101000001010101000001010000010000000001010000010100000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000101000001010101000001010000010000000001010000010100000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000101000000000000000001010000010000000001000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000101000000000000000001010000010000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000101000001010101000001010000010000000001010000010100000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000001010101000000000000010000000001010000010100000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000001010000010100000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
